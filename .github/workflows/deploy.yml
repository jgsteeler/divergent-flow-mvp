name: Deploy

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

# Prevent multiple deploys from overlapping
concurrency:
  group: deploy-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  deployments: write
  statuses: write

jobs:
  # Step 1: Version management (only on main branch pushes)
  release-please:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      backend_release_created: >-
        ${{ steps.release.outputs.backend--release_created }}
      frontend_release_created: >-
        ${{ steps.release.outputs.frontend--release_created }}
      frontend_tag_name: >-
        ${{ steps.release.outputs.frontend--tag_name }}
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

  # Step 2: Deploy backend to staging
  deploy-backend-staging:
    runs-on: ubuntu-latest
    needs: release-please
    if: always() && (needs.release-please.result == 'success' || needs.release-please.result == 'skipped')
    environment:
      name: staging
      url: https://divergent-flow-api-staging.fly.dev/health
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Staging
        working-directory: backend
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --config fly.staging.toml --remote-only

  # Step 3: Deploy frontend to staging
  deploy-frontend-staging:
    runs-on: ubuntu-latest
    needs: release-please
    if: always() && (needs.release-please.result == 'success' || needs.release-please.result == 'skipped')
    environment:
      name: staging
      url: https://divergent-flow-staging.netlify.app
    permissions:
      contents: read
      deployments: write
      statuses: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        env:
          # Vite reads VITE_* at build time and bakes it into the static bundle.
          # If not set, the frontend falls back to localhost.
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://divergent-flow-api-staging.fly.dev' }}
          VITE_AUTH0_DOMAIN: ${{ secrets.VITE_AUTH0_DOMAIN }}
          VITE_AUTH0_CLIENT_ID: ${{ secrets.VITE_AUTH0_CLIENT_ID }}
          VITE_AUTH0_AUDIENCE: ${{ secrets.VITE_AUTH0_AUDIENCE }}
        run: npm run build

      - name: Deploy to Netlify Staging
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './frontend/dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions - staging'
          enable-pull-request-comment: true
          enable-commit-comment: false
          enable-commit-status: true
          enable-github-deployment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # Step 4: Deploy backend to production (only if release was created)
  deploy-backend-prod:
    runs-on: ubuntu-latest
    needs: [release-please, deploy-backend-staging, deploy-frontend-staging]
    if: needs.release-please.outputs.releases_created == 'true'
    environment:
      name: production
      url: https://divergent-flow-api.fly.dev/health
    permissions:
      contents: read
      deployments: write
      statuses: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Prod
        working-directory: backend
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --config fly.toml --remote-only
  
  # Step 5: Deploy frontend to production (only if release was created)
  deploy-frontend-prod:
    runs-on: ubuntu-latest
    needs: [release-please, deploy-backend-staging, deploy-frontend-staging]
    if: needs.release-please.outputs.releases_created == 'true'
    environment:
      name: production
      url: https://divergent-flow-prod.netlify.app
    permissions:
      contents: read
      deployments: write
      statuses: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Frontend
        working-directory: frontend
        env:
          # Vite reads VITE_* at build time and bakes it into the static bundle.
          # If not set, the frontend falls back to localhost.
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://divergent-flow-api.fly.dev' }}
          VITE_AUTH0_DOMAIN: ${{ secrets.VITE_AUTH0_DOMAIN }}
          VITE_AUTH0_CLIENT_ID: ${{ secrets.VITE_AUTH0_CLIENT_ID }}
          VITE_AUTH0_AUDIENCE: ${{ secrets.VITE_AUTH0_AUDIENCE }}
        run: npm run build

      - name: Deploy Frontend to Production
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './frontend/dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: >-
            Production deploy -
            Release ${{ needs.release-please.outputs.frontend_tag_name }}
          enable-pull-request-comment: false
          enable-commit-comment: false
          enable-commit-status: true
          enable-github-deployment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
